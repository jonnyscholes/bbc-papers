// January 1 1939 - august 31 1939 - how many times "hitler" vs "herr hitler"
// september 1 1939 - may 31 1940 - how many times "hitler" vs "herr hitler"

//http://www.britishnewspaperarchive.co.uk/search/results/1939-01-01/1940-05-01?basicsearch=hitler&somesearch=hitler&sortorder=score
// http://www.britishnewspaperarchive.co.uk/viewer/bl/0000687/19391109/157/0007
// http://www.britishnewspaperarchive.co.uk/viewer/download/bl/0000687/19391109/157/0007
// 0000290/19391011/251/0011
// curl 'http://www.britishnewspaperarchive.co.uk/viewer/items/bl/0000687/19391109/157/0007' 
// -H 'Cookie: _dc_gtm_UA-23710515-6=1; _dc_gtm_UA-50794264-1=1; _gat_UA-23710515-6=1; _gat_UA-50794264-1=1; __uvt=; sessionid=U5M6kiy76ox9Dm4ibqJMqVb16j4s8q7CyY3nmbbyHxvjChLnZGO4pg==; session_0=BivH+fhTy9wSoU6QTRoUbo5KIK12ob4KqBwuyAr82XjELg8Puyv4nMzdxnje0sMhi6KMPpg6rMwN/N0lTG19lB8mLT0ZDvw8n97gJg2aHd0npazAZozlBFXwpHXMH2DuQd5+o0+CUqnLNYLDsRaCFBptyR2WXijwdLlo+Vth+JKQRbU4nv0wc5s0eQBu2H9nVyhyCgpgi0GwfyEavrM5n9sfGuhzEAu2ROPrPeNZ3ro28/tjZEcVIfaqg/8MI2npjMNf28GMIqhTtZTvLpuTYo+IgXAwjJF+xDI8CHioii6EZwtRzjyqjginbh7aoscfYz1B50wCjxoevXDeIU0KHGXcQNXRi3EjVr6Z3OYjP6OnnJBzB0RGqzin3mkXe/atS7MRAD2EtqdJmsR5KxScWGRO5GgDzZdTfKfKeDJc3d/fvX9bF32Q1AgtRFXeR72DG9iWm/42zvkNk17iPdzyZWRazkx7aBJPNAXU7AQshWhNG+rplBMBN8AJ9ijGYpiC+xWHv50eOVF8Xggi2fYCCPqTQFxv/IlY; searchmodel0=; cookie_message=seen; uvts=1rotDkJSaLzk1iGG; _ga=GA1.3.740485074.1411521741; __utma=92253513.740485074.1411521741.1411521742.1411521742.1; __utmb=92253513.4.10.1411521742; __utmc=92253513; __utmz=92253513.1411521742.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); __ControllerTempData=AAEAAAD/////AQAAAAAAAAAEAQAAAOIBU3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWMuRGljdGlvbmFyeWAyW1tTeXN0ZW0uU3RyaW5nLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldLFtTeXN0ZW0uT2JqZWN0LCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQMAAAAHVmVyc2lvbghDb21wYXJlcghIYXNoU2l6ZQADAAgWU3lzdGVtLk9yZGluYWxDb21wYXJlcggAAAAACQIAAAAAAAAABAIAAAAWU3lzdGVtLk9yZGluYWxDb21wYXJlcgEAAAALX2lnbm9yZUNhc2UAAQEL' -H 'DNT: 1' -H 'Accept-Encoding: gzip,deflate,sdch' -H 'Accept-Language: en-US,en;q=0.8' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.122 Safari/537.36' 
// -H 'Accept: application/json, text/javascript, */*; q=0.01' 
// -H 'Referer: http://www.britishnewspaperarchive.co.uk/viewer/bl/0000687/19391109/157/0007' 
// -H 'X-Requested-With: XMLHttpRequest' 
// -H 'Connection: keep-alive' --compressed

// curl 'http://www.britishnewspaperarchive.co.uk/viewer/items/bl/0000290/19391011/251/0011' -H 'Cookie: _dc_gtm_UA-23710515-6=1; _dc_gtm_UA-50794264-1=1; _gat_UA-23710515-6=1; _gat_UA-50794264-1=1; __uvt=; sessionid=U5M6kiy76ox9Dm4ibqJMqVb16j4s8q7CyY3nmbbyHxvjChLnZGO4pg==; session_0=BivH+fhTy9wSoU6QTRoUbo5KIK12ob4KqBwuyAr82XjELg8Puyv4nMzdxnje0sMhi6KMPpg6rMwN/N0lTG19lB8mLT0ZDvw8n97gJg2aHd0npazAZozlBFXwpHXMH2DuQd5+o0+CUqnLNYLDsRaCFBptyR2WXijwdLlo+Vth+JKQRbU4nv0wc5s0eQBu2H9nVyhyCgpgi0GwfyEavrM5n9sfGuhzEAu2ROPrPeNZ3ro28/tjZEcVIfaqg/8MI2npjMNf28GMIqhTtZTvLpuTYo+IgXAwjJF+xDI8CHioii6EZwtRzjyqjginbh7aoscfYz1B50wCjxoevXDeIU0KHGXcQNXRi3EjVr6Z3OYjP6OnnJBzB0RGqzin3mkXe/atS7MRAD2EtqdJmsR5KxScWGRO5GgDzZdTfKfKeDJc3d/fvX9bF32Q1AgtRFXeR72DG9iWm/42zvkNk17iPdzyZWRazkx7aBJPNAXU7AQshWhNG+rplBMBN8AJ9ijGYpiC+xWHv50eOVF8Xggi2fYCCPqTQFxv/IlY; searchmodel0=; cookie_message=seen; uvts=1rotDkJSaLzk1iGG; _ga=GA1.3.740485074.1411521741; __utma=92253513.740485074.1411521741.1411521742.1411521742.1; __utmb=92253513.4.10.1411521742; __utmc=92253513; __utmz=92253513.1411521742.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); __ControllerTempData=AAEAAAD/////AQAAAAAAAAAEAQAAAOIBU3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWMuRGljdGlvbmFyeWAyW1tTeXN0ZW0uU3RyaW5nLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldLFtTeXN0ZW0uT2JqZWN0LCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQMAAAAHVmVyc2lvbghDb21wYXJlcghIYXNoU2l6ZQADAAgWU3lzdGVtLk9yZGluYWxDb21wYXJlcggAAAAACQIAAAAAAAAABAIAAAAWU3lzdGVtLk9yZGluYWxDb21wYXJlcgEAAAALX2lnbm9yZUNhc2UAAQEL' -H 'DNT: 1' -H 'Accept-Encoding: gzip,deflate,sdch' -H 'Accept-Language: en-US,en;q=0.8' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.122 Safari/537.36' -H 'Accept: application/json, text/javascript, */*; q=0.01' -H 'Referer: http://www.britishnewspaperarchive.co.uk/viewer/bl/0000687/19391109/157/0007' -H 'X-Requested-With: XMLHttpRequest' -H 'Connection: keep-alive' --compressed

// http://www.britishnewspaperarchive.co.uk/tags/itemocr/BL/0000378/19400328/034/0001


var request = require('request');
var cheerio = require('cheerio');	
var async = require('async');
var fs = require('fs');
var pg = require('pg');

// Settings for Hitler scrape

// var JAUrl = 'http://www.britishnewspaperarchive.co.uk/search/results/1939-01-01/1939-08-31?sortorder=score&basicsearch=%2bhitler&freesearch=hitler&page=';
// var JACount = 938;

// var SMUrl = 'http://www.britishnewspaperarchive.co.uk/search/results/1939-09-01/1940-05-31?basicsearch=%2bhitler&freesearch=hitler&sortorder=score&page=';
// var SMCount = 1640;




// var JAUrls = new Array(JACount+1)
//     .join().split(',')
//     .map(function(item, index){ return JAUrl + index++;});

// var SMUrls = new Array(SMCount+1)
//     .join().split(',')
//     .map(function(item, index){ return SMUrl + index++;});

// var allUrls = JAUrls.concat(SMUrls);

var naziUrl =   'http://www.britishnewspaperarchive.co.uk/search/results/1939-01-01/1940-05-31?basicsearch=nazi&somesearch=nazi&sortorder=score&page=';
var naziPages = 2694;

var germanUrl = 'http://www.britishnewspaperarchive.co.uk/search/results/1939-01-01/1940-05-31?basicsearch=%2bgerman&freesearch=german&sortorder=score&page=';
var germanPages = 7775;

var globalClient;
var baseArticleTextUrl = 'http://www.britishnewspaperarchive.co.uk/tags/itemocr/BL/';
var conString = "postgres://bbc:phatbeats@localhost:5432/bbcpapers";
var addQuery = 'insert into articles (id, url, pub_date, newspaper, page_number, no_words, article_text, type, search_term) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)';

var allUrls = new Array(germanPages+1)
    .join().split(',')
    .map(function(item, index){ return germanUrl + index++;});

var testUrl = naziUrl+'0';

pg.connect(conString, function(err, client, done) {
	if(err) throw err;
	globalClient = client;

 	async.eachLimit(allUrls, 5, extractStoryUrls, function(err){
		done();
		client.end();
	});
});


/*
* @async PassThrough
*/
function extractStoryUrls(searchPageUrl, asyncCallback) {
	request(searchPageUrl, function (error, response, body) {
		if (error) throw error;

		if (!error && response.statusCode == 200) {
			var $ = cheerio.load(body);
			var $items = $('#main .itemContainer');
			$items.each(function(i, elm){
				var url = $(elm).find('.thumbnailContainer a').first().attr('href');
				var id = url.split('/').slice(3).join('-');
				var pub_date = $(elm).find('.date').first().text();
				var newspaper = $(elm).find('.itemSubDetails strong a').first().text();
				var page_number = parseInt($(elm).find('.itemSubDetails strong').eq(3).text(), 10);
				var no_words = $(elm).find('.itemSubDetails strong').eq(2).text();
				var type = $(elm).find('.itemSubDetails strong').eq(1).text();
				console.log(url, id, pub_date, newspaper, page_number, no_words, type);
				if(i == $items.length-1) {
					console.log('Final from: ', searchPageUrl);
					handleArticle(url, id, pub_date, newspaper, page_number, no_words, type, asyncCallback);
				} else {
					handleArticle(url, id, pub_date, newspaper, page_number, no_words, type);
				}
			});
		}
	});
}

/*
* @async End
*/
function handleArticle(url, id, pub_date, newspaper, page_number, no_words, type, asyncCallback) {
	request(baseArticleTextUrl+url.split('/').slice(3).join('/'), function (error, response, body) {
		var article_text = JSON.parse(body).map(function(obj){
			return obj['LineText'];
		}).join(';;').replace(/\s{2,}/g, ' ');

		globalClient.query(addQuery, [id, url, pub_date, newspaper, page_number, no_words, article_text, type, 'german'], function(err, result) {
			if(err) throw err;

			if(asyncCallback){
				asyncCallback();
			}
		});
	});	
}